### Přerušení

- přerušovací systém reaguje na určitou událost
	- **hardwarové událost (nejčastěji nastávají přímo v mcu)**
		- změna hodnoty na I/O pinu - externí přerušení
		- přetečení čítače / časovače - interení přerušení
	- **softwarové událostoti**
		- neplatná adresa
		- neplatný operační znak

### Obsluha

- reaguje na událost
- přeruší běžící program
- řízení se předá nějaké speciální adrese (vektoru)
	- na adrese je buď řídící podprogram
	- nebo se zde nachází skok na řídící podprogram (častější)

### Přerušovací vektor

- **vektor** = **adreasa, kam se předá řízení**
- interrupt vektory
- stupňují se po dvou adresách
	- aby se zde vešel skok na místo podprogramu
	- adresy 0x0000, 0x0002, 0x0004...
- dělí se na:
	- **každá událost má svůj vlastní interrupt vektor - ATmega64**
	- jen některé události mají vlastní interrupt vektor (ostatní ho sdílejí - kombinovaný režim) - Intel
	- existuje pouze jeden interrupt vektor pro celé mcu, poté nutnost softwarově vyhodnotit - Microchip

### Povolení

- každá událost se musí povolit
- po resetu jsou všechny defaultně zakázané
- v příznakovém registru je bit, který globálně ovládá všechny události v mcu (povolit/zakázat)
	- použije se v případě, že je nějaká událost vyvolána (aby ji nenahradila nějaká další, než se dokončí řízení té první)

### Příznak

- interpretován registrem (v případě vícestatového registru => lze nastavit více příznakových stavů)
- každá událost má vlastní interrupt flag (příznak)
	- jeden příznak je povolení přerušení
	- druhý příznak je informace, že k přerušení došlo
- příznaky lze nulovat hardwarově i softwarově
	- softwarově lze nulovat kdykoliv
	- hardwarově ho dokáží některé systémy vynulovat samy

### Priorita

- pokud vznikne událost během aktivity / řízení jiné události 
- 2 možnosti řešení
	- hardwarově
	- softwarově
- u některých systémů lze každému interruptu nastavit prioritu
- **u ATmega64 a většiny mcu** - pořadí interrupt vektorů v paměti je určován prioritou
- pokud je vyžádána událost s větší prioritou, než je ta současně probíhající => většina sytémů tu současno přestane řešit (prvně se provede událost s vyšší prioritou, později se navráti k původní události)

### Kontext

- po přerušení se program dostane na určitou adresu
- na této adrese se musí na přerušení softwarově reagovat
	- probíhají určité intstrukce, které mohou mít vliv na obsah registrů
- nastává problém, **že se po vyřešení úlohy / události navrátíme zpět s modifikovanými registry**
	- obsluha přerušení musí zajistit, že se obsah registrů, se kterými pracuje **zůstane nezeměněn**
	- obsluha na začátku řešení události uloží obsah registrů, se kterými bude pracovat
		- původní obsah registrů se nazývá **kontext**
	- na konci řešení se do registrů vrátí původní hodnoty

### Zpracování

- během každého instrukčního cyklu se vyhodnocuje, zda nenastala nějaká událost
- pokud vznikla a je povolená => obsah následující instrukce se uloží
- do program counteru se nahraje příslušný **interrupt vector**
	- přijde skok na adresu obsluhy přerušení
- zapíše se 0 do **global interrupt enable** (zakázání)
- provede se obsluha přerušení
- zapíše se 1 do **global interrupt enable** (povolení)
- zpětně se najde poslední instrukce, kde jsme přerušili program => místo, kam se máme navrátit
- program pokračuje dál

### Přerušovací systém Atmel AVR

- každá událost má vlastní interrupt vektor
- pořadí interrupt vektorůů v paměti určuje jejich prioritu
![[Pasted image 20230215092814.png]]

![[Pasted image 20230215092858.png]]